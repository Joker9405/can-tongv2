# 修复 lexeme_suggestions 400 错误和 telemetry_search hit_status 的完整方案

## 问题总结

1. **400 错误**：`lexeme_suggestions` 插入请求返回 400
2. **SQL 错误**：`telemetry_search` 表没有 `text` 列，应该是 `q` 列
3. **hit_status 更新**：需要根据词库匹配情况更新 `hit_status` 为 `bingo` 或 `miss`

## 已完成的修复

### 1. BlueCard.tsx 和 AddWordDrawer.tsx

✅ **已修复**：
- 移除了 `created_at` 字段（数据库自动生成）
- 移除了 `.select()` 调用（避免权限问题）
- BlueCard 实现了根据 `searchTerm` 自动填充 `chs`/`en` 字段
- 添加了 `type="button"` 和 `event.preventDefault()` 防止表单提交

### 2. SQL 修复

✅ **已修复**：
- 将 `ts.text` 改为 `ts.q`（正确的列名）

## 如果仍然看到 400 错误

### 可能原因

1. **浏览器缓存**：旧的 JavaScript 代码仍在运行
   - **解决方案**：硬刷新浏览器（Ctrl+Shift+R 或 Cmd+Shift+R）
   - 或者清除浏览器缓存

2. **Vercel 部署缓存**：部署的代码可能还是旧版本
   - **解决方案**：重新部署到 Vercel，确保最新代码已推送

3. **字段不匹配**：检查 Supabase 表结构
   - 确认 `lexeme_suggestions` 表有以下字段：
     - `seed_q` (text, nullable)
     - `zhh` (text, nullable)
     - `zhh_pron` (text, nullable)
     - `chs` (text)
     - `en` (text)
     - `source` (text)
     - `status` (text)
     - `is_r18` (integer)
     - `created_at` (timestamptz, 自动生成)

### 验证步骤

1. **检查 Network 请求**：
   - 打开 F12 → Network
   - 点击 "go" 按钮
   - 查看 `lexeme_suggestions` 请求
   - **正确的请求应该是**：
     - URL: `POST .../rest/v1/lexeme_suggestions`
     - **不应该有** `?columns=...` 参数
     - Status: 200 或 201

2. **检查请求 Payload**：
   - 点击 Network 中的请求
   - 查看 Request Payload
   - 应该包含：`zhh`, `chs`, `en`, `source`, `status`, `is_r18`, `seed_q`
   - **不应该包含**：`word`, `created_at`

## SQL 执行步骤

### 修复 telemetry_search.hit_status

1. **打开 Supabase SQL Editor**

2. **执行以下 SQL**（根据你的情况选择）：

#### 方案一：基于 lexeme_suggestions（推荐）

```sql
-- 先全部标记为 miss
UPDATE public.telemetry_search
SET hit_status = 'miss';

-- 把命中 lexeme_suggestions（已审核的词）的搜索标记为 bingo
UPDATE public.telemetry_search ts
SET hit_status = 'bingo'
FROM public.lexeme_suggestions ls
WHERE ts.q IS NOT NULL
  AND ts.q <> ''
  AND ls.status = 'approved'  -- 只匹配已审核的词
  AND (
    ts.q = ls.zhh
    OR ts.q = ls.chs
    OR ts.q = ls.en
  );
```

#### 方案二：基于 lexeme_suggestions（所有词，不管状态）

```sql
-- 先全部标记为 miss
UPDATE public.telemetry_search
SET hit_status = 'miss';

-- 把命中 lexeme_suggestions（所有词）的搜索标记为 bingo
UPDATE public.telemetry_search ts
SET hit_status = 'bingo'
FROM public.lexeme_suggestions ls
WHERE ts.q IS NOT NULL
  AND ts.q <> ''
  AND (
    ts.q = ls.zhh
    OR ts.q = ls.chs
    OR ts.q = ls.en
  );
```

#### 方案三：如果有 lexeme 表（从 CSV 导入）

```sql
-- 先全部标记为 miss
UPDATE public.telemetry_search
SET hit_status = 'miss';

-- 把命中 lexeme 表的搜索标记为 bingo
UPDATE public.telemetry_search ts
SET hit_status = 'bingo'
FROM public.lexeme lx
WHERE ts.q IS NOT NULL
  AND ts.q <> ''
  AND (
    ts.q = lx.zhh
    OR ts.q = lx.chs
    OR ts.q = lx.en
  );
```

## 测试检查清单

- [ ] 硬刷新浏览器（Ctrl+Shift+R）
- [ ] 检查 Network 面板，确认没有 400 错误
- [ ] 测试 BlueCard 的 Revise 功能，确认能成功插入
- [ ] 测试 AddWordDrawer，确认能成功插入
- [ ] 检查 Supabase 表，确认数据已插入
- [ ] 执行 SQL 更新 hit_status
- [ ] 检查 telemetry_search 表，确认 hit_status 已更新

## 如果问题仍然存在

请提供以下信息：
1. Network 面板中 400 错误的完整请求 URL
2. 400 错误的 Response 内容
3. Supabase 表 `lexeme_suggestions` 的实际字段结构（截图）
